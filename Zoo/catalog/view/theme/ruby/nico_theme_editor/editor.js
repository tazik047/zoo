var nico_theme_path = "/catalog/view/theme/ruby/";
var _fonts = '<option>Open Sans</option><option>Roboto</option><option>Oswald</option><option>Lato</option><option>Droid Sans</option><option>Open Sans Condensed</option><option>PT Sans</option><option>Source Sans Pro</option><option>Roboto Condensed</option><option>Ubuntu</option><option>Droid Serif</option><option>PT Sans Narrow</option><option>Montserrat</option><option>Raleway</option><option>Yanone Kaffeesatz</option><option>Lora</option><option>Lobster</option><option>Arimo</option><option>Francois One</option><option>Bitter</option><option>Oxygen</option><option>Arvo</option><option>Titillium Web</option><option>Dosis</option><option>Varela Round</option><option>Noto Sans</option><option>Merriweather</option><option>Play</option><option>PT Serif</option><option>Cabin</option><option>Roboto Slab</option><option>Josefin Sans</option><option>Ubuntu Condensed</option><option>Abel</option><option>Cuprum</option><option>Libre Baskerville</option><option>Muli</option><option>Rokkitt</option><option>Inconsolata</option><option>Fjalla One</option><option>Indie Flower</option><option>News Cycle</option><option>Nunito</option><option>Maven Pro</option><option>Anton</option><option>Playfair Display</option><option>Merriweather Sans</option><option>Archivo Narrow</option><option>Shadows Into Light</option><option>Signika</option><option>Cardo</option><option>Asap</option><option>The Girl Next Door</option><option>Armata</option><option>Gentium Book Basic</option><option>Pacifico</option><option>Bree Serif</option><option>Dancing Script</option><option>Coming Soon</option><option>Hammersmith One</option><option>PT Sans Caption</option><option>Questrial</option><option>Droid Sans Mono</option><option>Vollkorn</option><option>Allan</option><option>Nobile</option><option>Alegreya</option><option>Karla</option><option>Quicksand</option><option>Audiowide</option><option>Cabin Condensed</option><option>Voltaire</option><option>Ubuntu Mono</option><option>Kreon</option><option>Exo</option><option>Istok Web</option><option>Poiret One</option><option>Pathway Gothic One</option><option>Changa One</option><option>Chewy</option><option>Monda</option><option>Crafty Girls</option><option>Gudea</option><option>Philosopher</option><option>Pontano Sans</option><option>Gloria Hallelujah</option><option>Varela</option><option>Luckiest Guy</option><option>Ropa Sans</option><option>Playball</option><option>Rock Salt</option><option>Squada One</option><option>Nothing You Could Do</option><option>Special Elite</option><option>Telex</option><option>Noto Serif</option><option>Patua One</option><option>Quattrocento Sans</option><option>Fredoka One</option><option>Montserrat Alternates</option><option>Lusitana</option><option>Josefin Slab</option><option>Crimson Text</option><option>Bangers</option><option>Lemon</option><option>Cantarell</option><option>Lobster Two</option><option>Covered By Your Grace</option><option>Jockey One</option><option>Noticia Text</option><option>Permanent Marker</option><option>Crete Round</option><option>Marvel</option><option>EB Garamond</option><option>Calligraffitti</option><option>Comfortaa</option><option>Bevan</option><option>Economica</option><option>Oleo Script</option><option>Cantata One</option><option>Old Standard TT</option><option>Amatic SC</option><option>BenchNine</option><option>Chivo</option><option>Tinos</option><option>Allerta</option><option>Cherry Cream Soda</option><option>Satisfy</option><option>Righteous</option><option>Amaranth</option><option>Architects Daughter</option><option>Shadows Into Light Two</option><option>Handlee</option><option>Metrophobic</option><option>Archivo Black</option><option>Orbitron</option><option>Kaushan Script</option><option>Black Ops One</option><option>Paytone One</option><option>Tangerine</option><option>Sanchez</option><option>Molengo</option><option>Patrick Hand</option><option>Pinyon Script</option><option>Passion One</option><option>Quattrocento</option><option>Exo 2</option><option>Carme</option><option>Sigmar One</option><option>Source Code Pro</option><option>Reenie Beanie</option><option>Enriqueta</option><option>Waiting for the Sunrise</option><option>Domine</option><option>Marck Script</option><option>Actor</option><option>Playfair Display SC</option><option>Unkempt</option><option>Walter Turncoat</option><option>Kameron</option><option>Just Me Again Down Here</option><option>Rancho</option><option>Syncopate</option><option>Didact Gothic</option><option>Marmelad</option><option>Scada</option><option>Vidaloka</option><option>Share</option><option>Carrois Gothic</option><option>Coda</option><option>Electrolize</option><option>Gilda Display</option><option>Loved by the King</option><option>Antic Slab</option><option>Copse</option><option>Rambla</option><option>Rosario</option><option>Great Vibes</option><option>Just Another Hand</option><option>Goudy Bookletter 1911</option><option>Berkshire Swash</option><option>Leckerli One</option><option>Jura</option><option>Overlock</option><option>Neucha</option><option>Ruda</option><option>Courgette</option><option>Doppio One</option><option>PT Serif Caption</option><option>Aldrich</option><option>Viga</option><option>Allerta Stencil</option><option>Sintony</option><option>Rochester</option><option>Cinzel</option><option>Russo One</option><option>Bad Script</option><option>Michroma</option><option>Signika Negative</option><option>Julius Sans One</option><option>Sorts Mill Goudy</option><option>Schoolbell</option><option>Inder</option><option>Abril Fatface</option><option>Homemade Apple</option><option>Fugaz One</option><option>Coustard</option><option>Glegoo</option><option>Damion</option><option>Alfa Slab One</option><option>Six Caps</option><option>Judson</option><option>Love Ya Like A Sister</option><option>Nova Square</option><option>Gochi Hand</option><option>Belleza</option><option>Fauna One</option><option>Volkhov</option><option>Englebert</option><option>Sansita One</option><option>Neuton</option><option>Convergence</option><option>Spirax</option><option>Arapey</option><option>Fontdiner Swanky</option><option>Magra</option><option>Cabin Sketch</option><option>Cutive</option><option>ABeeZee</option><option>Crushed</option><option>Limelight</option><option>Puritan</option><option>Alegreya Sans</option><option>Nixie One</option><option>Give You Glory</option><option>Arbutus Slab</option><option>Slackey</option><option>Gentium Basic</option><option>Boogaloo</option><option>Montez</option><option>Advent Pro</option><option>Alegreya Sans SC</option><option>Petit Formal Script</option><option>Caudex</option><option>Radley</option><option>Poller One</option><option>Trocchi</option><option>Salsa</option><option>Merienda One</option><option>Prata</option><option>Gruppo</option><option>Denk One</option><option>Orienta</option><option>Allura</option><option>Yellowtail</option><option>Homenaje</option><option>Lekton</option><option>Metamorphous</option><option>Chau Philomene One</option><option>Fredericka the Great</option><option>Marcellus SC</option><option>Days One</option><option>Spinnaker</option><option>Cookie</option><option>Mako</option><option>Alef</option><option>Quando</option><option>Duru Sans</option><option>Ultra</option><option>Parisienne</option><option>Andika</option><option>Iceland</option><option>Strait</option><option>Headland One</option><option>Kranky</option><option>Kotta One</option><option>Bentham</option><option>Acme</option><option>Tenor Sans</option><option>Fanwood Text</option><option>Sacramento</option><option>Candal</option><option>Niconne</option><option>Prosto One</option><option>IM Fell English</option><option>Alike</option><option>Shanti</option><option>Happy Monkey</option><option>Anonymous Pro</option><option>Sancreek</option><option>Pompiere</option><option>Racing Sans One</option><option>Cousine</option><option>Sunshiney</option><option>Wendy One</option><option>Brawler</option><option>Tienne</option><option>Forum</option><option>Kristi</option><option>Oleo Script Swash Caps</option><option>Average Sans</option><option>Fenix</option><option>Merienda</option><option>Quantico</option><option>La Belle Aurore</option><option>Short Stack</option><option>Anaheim</option><option>Ovo</option><option>Delius</option><option>Codystar</option><option>Adamina</option><option>Mountains of Christmas</option><option>Alex Brush</option><option>Yesteryear</option><option>Basic</option><option>Alice</option><option>Contrail One</option><option>Gafata</option><option>Alegreya SC</option><option>IM Fell DW Pica</option><option>Carrois Gothic SC</option><option>Aclonica</option><option>Averia Sans Libre</option><option>Carter One</option><option>Over the Rainbow</option><option>Kelly Slab</option><option>Podkova</option><option>Coda Caption</option><option>Sue Ellen Francisco</option><option>Tulpen One</option><option>Kavoon</option><option>Frijole</option><option>Norican</option><option>Quintessential</option><option>Yeseva One</option><option>Nova Round</option><option>Wire One</option><option>Tauri</option><option>Press Start 2P</option><option>Finger Paint</option><option>Annie Use Your Telescope</option><option>Geo</option><option>Corben</option><option>Chango</option><option>Cedarville Cursive</option><option>Delius Swash Caps</option><option>Expletus Sans</option><option>Krona One</option><option>Sonsie One</option><option>Maiden Orange</option><option>Rationale</option><option>Capriola</option><option>Stardos Stencil</option><option>Voces</option><option>Dawning of a New Day</option><option>Antic</option><option>Skranji</option><option>Lily Script One</option><option>Baumans</option><option>Federo</option><option>Bowlby One SC</option><option>Lilita One</option><option>Andada</option><option>Megrim</option><option>Cantora One</option><option>Vibur</option><option>Cinzel Decorative</option><option>Cutive Mono</option><option>Galdeano</option><option>Mouse Memoirs</option><option>Buenard</option><option>Zeyada</option><option>Delius Unicase</option><option>IM Fell English SC</option><option>UnifrakturMaguntia</option><option>Imprima</option><option>Poly</option><option>IM Fell DW Pica SC</option><option>VT323</option><option>PT Mono</option><option>Miltonian Tattoo</option><option>Redressed</option><option>Marcellus</option><option>Meddon</option><option>Italianno</option><option>Unna</option><option>Lustria</option><option>Nova Mono</option><option>Knewave</option><option>Mate SC</option><option>Belgrano</option><option>Grand Hotel</option><option>Hanuman</option><option>IM Fell French Canon</option><option>Clicker Script</option><option>Simonetta</option><option>Swanky and Moo Moo</option><option>GFS Didot</option><option>Bowlby One</option><option>Share Tech</option><option>Chelsea Market</option><option>Inika</option><option>MedievalSharp</option><option>IM Fell Double Pica</option><option>Numans</option><option>IM Fell Great Primer SC</option><option>Oranienbaum</option><option>Amethysta</option><option>Sofia</option><option>Monoton</option><option>Revalia</option><option>Port Lligat Slab</option><option>Holtwood One SC</option><option>Snippet</option><option>Gabriela</option><option>Vast Shadow</option><option>Rufina</option><option>Oregano</option><option>Graduate</option><option>Dorsa</option><option>Donegal One</option><option>Gravitas One</option><option>Julee</option><option>Rammetto One</option><option>Prociono</option><option>Patrick Hand SC</option><option>Arizonia</option><option>Average</option><option>Unica One</option><option>Fjord One</option><option>Buda</option><option>Sniglet</option><option>Ruslan Display</option><option>Junge</option><option>Qwigley</option><option>UnifrakturCook</option><option>Kite One</option><option>IM Fell French Canon SC</option><option>Oldenburg</option><option>Artifika</option><option>Oxygen Mono</option><option>Geostar Fill</option><option>Mystery Quest</option><option>Amarante</option><option>Londrina Solid</option><option>Petrona</option><option>Condiment</option><option>Monofett</option><option>IM Fell Great Primer</option><option>Euphoria Script</option><option>Mr De Haviland</option><option>Irish Grover</option><option>Trochut</option><option>Linden Hill</option><option>Astloch</option><option>Jolly Lodger</option><option>League Script</option><option>Wallpoet</option><option>Mate</option><option>Sail</option><option>Rouge Script</option><option>Kenia</option><option>Life Savers</option><option>Bubblegum Sans</option><option>Overlock SC</option><option>Della Respira</option><option>Ledger</option><option>Dynalight</option><option>Nova Slim</option><option>Creepster</option><option>Flamenco</option><option>Nova Flat</option><option>IM Fell Double Pica SC</option><option>Cambo</option><option>Averia Serif Libre</option><option>Modern Antiqua</option><option>Esteban</option><option>Concert One</option><option>Alike Angular</option><option>Nova Script</option><option>Rum Raisin</option><option>Engagement</option><option>Balthazar</option><option>Medula One</option><option>Bigshot One</option><option>Ranchers</option><option>Milonga</option><option>Bilbo Swash Caps</option><option>Paprika</option><option>Mr Dafoe</option><option>Smythe</option><option>Text Me One</option><option>Molle</option><option>Sofadi One</option><option>Shojumaru</option><option>Seaweed Script</option><option>Snowburst One</option><option>Nova Oval</option><option>Lovers Quarrel</option><option>Rosarivo</option><option>Cagliostro</option><option>Raleway Dots</option><option>Stint Ultra Condensed</option><option>Geostar</option><option>Jacques Francois Shadow</option><option>Asset</option><option>Ruluko</option><option>Lancelot</option><option>Goblin One</option><option>Smokum</option><option>Atomic Age</option><option>Miniver</option><option>Passero One</option><option>Port Lligat Sans</option><option>Pirata One</option><option>Gorditas</option><option>Nova Cut</option><option>Trade Winds</option><option>Henny Penny</option><option>Aubrey</option><option>Federant</option><option>Montaga</option><option>Jacques Francois</option><option>Miltonian</option><option>GFS Neohellenic</option><option>Aladin</option><option>Stoke</option><option>Griffy</option><option>Supermercado One</option><option>Bilbo</option><option>Devonshire</option><option>Seymour One</option><option>Elsie Swash Caps</option><option>Londrina Shadow</option><option>Titan One</option><option>Suwannaphum</option><option>Rye</option><option>Iceberg</option><option>Peralta</option><option>Glass Antiqua</option><option>Keania One</option><option>Cherry Swash</option><option>Fondamento</option><option>Autour One</option><option>Fresca</option><option>Caesar Dressing</option><option>Averia Libre</option><option>Wellfleet</option><option>Emblema One</option><option>Aguafina Script</option><option>Ruthie</option><option>Chela One</option><option>McLaren</option><option>Spicy Rice</option><option>Share Tech Mono</option><option>Khmer</option><option>Freckle Face</option><option>Habibi</option><option>Bubbler One</option><option>Italiana</option><option>Monsieur La Doulaise</option><option>Trykker</option><option>Elsie</option><option>Montserrat Subrayada</option><option>Piedra</option><option>Freehand</option><option>Croissant One</option><option>Germania One</option><option>Antic Didone</option><option>Nosifer</option><option>Offside</option><option>Eagle Lake</option><option>Stalemate</option><option>Asul</option><option>Nokora</option><option>Akronim</option><option>Battambang</option><option>Purple Purse</option><option>Mrs Saint Delafield</option><option>Original Surfer</option><option>Diplomata</option><option>Ceviche One</option><option>Bigelow Rules</option><option>Stint Ultra Expanded</option><option>Galindo</option><option>Ribeye</option><option>Chicle</option><option>Mrs Sheppards</option><option>Meie Script</option><option>Risque</option><option>Emilys Candy</option><option>Eater</option><option>Almendra</option><option>Ewert</option><option>Sarina</option><option>Fascinate</option><option>Butterfly Kids</option><option>Sevillana</option><option>Joti One</option><option>Odor Mean Chey</option><option>Princess Sofia</option><option>Angkor</option><option>Ribeye Marrow</option><option>Arbutus</option><option>Sirin Stencil</option><option>Felipa</option><option>Dr Sugiyama</option><option>Marko One</option><option>Combo</option><option>Londrina Sketch</option><option>Dangrek</option><option>Romanesco</option><option>Moulpali</option><option>Margarine</option><option>Kdam Thmor</option><option>Mr Bedfort</option><option>Bokor</option><option>Averia Gruesa Libre</option><option>Metal Mania</option><option>Faster One</option><option>Macondo Swash Caps</option><option>Londrina Outline</option><option>Vampiro One</option><option>Herr Von Muellerhoff</option><option>Moul</option><option>Miss Fajardose</option><option>Flavors</option><option>Kantumruy</option><option>New Rocker</option><option>Content</option><option>Butcherman</option><option>Bayon</option><option>Uncial Antiqua</option><option>Underdog</option><option>Macondo</option><option>Stalinist One</option><option>Ruge Boogie</option><option>Koulen</option><option>Fascinate Inline</option><option>Diplomata SC</option><option>Almendra SC</option><option>Bonbon</option><option>Jim Nightshade</option><option>Preahvihear</option><option>Siemreap</option><option>Unlock</option><option>Taprom</option><option>Metal</option><option>Erica One</option><option>Hanalei Fill</option><option>Chenla</option><option>Hanalei</option><option>Plaster</option><option>Almendra Display</option><option>Fruktur</option><option>Warnes</option><option>Fasthand</option>';
var _fonts_sizes = "<option value=''>Default</option>";
var _slide_text_template =
'<div class="slider_text">\
 <div class="value">\
	<table>\
	<tr>\
		<td><label>Title</label></td>\
		<td><input type="text" name="slider_title"/></td>\
	</tr>\
	<!-- <tr>\
		<td><label>Subtitle</label></td>\
		<td><input type="text" name="slider_subtitle"/></td>\
	</tr> -->\
	<tr>\
		<td><label>Description</label></td>\
		<td><textarea name="slider_description"></textarea></td>\
	</tr>\
	</table>\
 </div>\
</div>';		 
var background_style = '';			 

for (var i = 8;i < 65;i++)
{
		_fonts_sizes += "<option value='" + i + "'>" + i + "</option>";
}


function rgb2hex(rgb){
 if (!rgb) return '';
 rgb = rgb.match(/^rgba?[\s+]?\([\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?/i);
 return (rgb && rgb.length === 4) ? "#" +
  ("0" + parseInt(rgb[1],10).toString(16)).slice(-2) +
  ("0" + parseInt(rgb[2],10).toString(16)).slice(-2) +
  ("0" + parseInt(rgb[3],10).toString(16)).slice(-2) : '';
}

var _nico_changes = {};
var _background_backup;

function normalize_string(str)
{
	return str.toLowerCase().replace(/[ -,\.;]/g,'_');
}

var _nico_save_message = "Done";
if (_nico_demo == true) _nico_save_message = "Saving is disabled in the DEMO version!";

function nico_save_theme()
{
	_nico_changes['slider_text'] = {};
	for (l in lang)
	{
		_nico_changes['slider_text'][lang[l]] = {};
		_nico_changes['slider_text'][lang[l]]['title'] = [];
		_nico_changes['slider_text'][lang[l]]['subtitle'] = [];
		_nico_changes['slider_text'][lang[l]]['description'] = [];
		
		var i = -1;
		jQuery("#nico_theme_editor .nico_slide_text.lang_" + [lang[l]]  + " .slider_text input, #nico_theme_editor .nico_slide_text.lang_" + [lang[l]]  + " div.slider_text textarea").each(function ()
		{
			if (this.name == 'slider_title')
			{
				i++;
				if (!_nico_changes['slider_text'][lang[l]][i]) _nico_changes['slider_text'][lang[l]][i] = {};
				_nico_changes['slider_text'][lang[l]][i]['title'] = this.value; 
			} else if (this.name == 'slider_subtitle')
			{
				if (!_nico_changes['slider_text'][lang[l]][i]) _nico_changes['slider_text'][lang[l]][i] = {};
				_nico_changes['slider_text'][lang[l]][i]['subtitle'] = this.value; 
			} else if (this.name == 'slider_description')
			{
				if (!_nico_changes['slider_text'][lang[l]][i]) _nico_changes['slider_text'][lang[l]][i] = {};
				_nico_changes['slider_text'][lang[l]][i]['description'] = this.value; 
			}
		});
   }
   
	var menu = [];
	function processOneLi(node) {       
		if (node.hasClass("categories"))
		{
			 var retVal = {
				"categories": true,
			}
		} else
		{
			var retVal = {};
			jQuery("> div > input", node).each(function() 
			{
				var $this = jQuery(this);
				var name = $this.attr("name");
				var val = $this.val();
				if (name == 'url' && val != '' ) retVal['url'] = $this.val();
				else
				{
				    if (!retVal['text']) retVal['text'] = {};
				    if (val != '') retVal['text'][name] = val;
				}
			});
		}
		
		node.find("> ul > li").each(function() {
			if (!retVal.hasOwnProperty("children")) {
				retVal.children = [];
			}
			retVal.children.push(processOneLi($(this)));
		});
		return retVal;
	}
	$("#nico_menu ul.jstree-no-dots > li").each(function() {
		menu.push(processOneLi($(this)));
	});

	_nico_changes['menu'] = menu;

	var path = document.location.pathname;
	if (typeof path == "undefined") path = "";

	jQuery(".nico_status").text("Saving ...").show()
	$.ajax({
	  type:"POST",
	  url: path,
	  data:_nico_changes,
	  context: document.body
	}).done(function() { 
		var queryString = '?reload=' + new Date().getTime();
		
		$('link[rel="stylesheet"]._editor_css').attr("href", function () 
		{ 
			return this.href.replace(/\?.*|$/, queryString);
		});
		jQuery(".nico_status").text(_nico_save_message).show()
		
		_nico_changes = {};
		_nico_changes['styles'] = {};
		setTimeout('jQuery(".nico_status").text("").hide();', 2000);
	});		
}	

function init_backgrounds()
{
		jQuery("#nico_theme_editor .pattern .value").hover(
		  function (e) 
		  {
			var body = jQuery("body");
			var $this = jQuery(this);

			_background_backup = body.css('background-image');
			body.css('background-image', $this.css('background-image'));
		  }, 
		  function (e) 
		  {
			var body = jQuery("body");
			body.css('background-image', _background_backup);
		  }
		).click(function (e)
		{
			var body = jQuery("body");
			var $this = jQuery(this);
			jQuery("#nico_theme_editor .pattern .value").removeClass("selected");
			_nico_changes['background-image'] = _background_backup = $this.addClass("selected").css('background-image');
			body.attr("style",'background-image:'+ _nico_changes['background-image'] + ';background-size:auto;' + background_style);
		});
		
		jQuery("#nico_theme_editor #background-style").on("change", function() 
		{
			_nico_changes['background-style'] = this.value;
			switch(this.value)
			{
					case 'repeat':
						background_style = 'background-repeat:repeat';
					break;
					case 'repeat-x':
						background_style = 'background-repeat:repeat-x';
					break;
					case 'repeat-y':
						background_style = 'background-repeat:repeat-y';
					break;
					case 'stretch':
						background_style = 'background-size:100%;background-size:cover';
					break;
					case 'no-repeat':
						background_style = 'background-repeat:no-repeat';
			}
			
			jQuery("body").attr("style",'background-image:' + _background_backup + ';background-size:auto;' + background_style);
		});
			
}

function init_colors()
{
		jQuery("#nico_theme_editor .color").each(function() 
		{
			var element = jQuery(".value", this);
			var back_color = "";
			back_color = element.attr("default");
			if (back_color == "") back_color = jQuery(element.attr("selector")).css(element.attr("attribute"));
			
			if (typeof back_color != "undefined" && back_color.charAt(0) != "#") back_color = rgb2hex(back_color);
			
			element.css({backgroundColor:back_color});
			$(element).ColorPicker({
				color: back_color,
				onShow: function (colpkr) {
					$(colpkr).fadeIn(500);
					return false;
				},
				onHide: function (colpkr) {
					$(colpkr).fadeOut(500);
					return false;
				},
				onChange: function (hex, el) {
					var element = $(el);
					element.css('backgroundColor', '#' + hex);
					jQuery(element.attr("selector")).css(element.attr("attribute"), "#" + hex);

					if (!_nico_changes["colors"]) _nico_changes["colors"] = {};
					if (!_nico_changes["colors"][element.attr("selector")]) _nico_changes["colors"][element.attr("selector")] = {};
					_nico_changes['colors'][element.attr("selector")][element.attr("attribute")] = '#' + hex;
				}
			});
		});
}

function init_fonts()
{
		jQuery("#nico_theme_editor ._font_select").each(function() 
		{
			var element = jQuery(this);
			element.html(_fonts);
			var font_family = element.attr("default");
			if (!font_family) font_family = jQuery(element.attr("selector")).css("font-family");
			element.val(font_family);
				/*var element = $(this);
				jQuery(element.attr("selector")).css({fontFamily:this.value});*/
		});
		
		jQuery("#nico_theme_editor ._font_select_size").each(function() 
		{
			var element = jQuery(this);
			element.html(_fonts_sizes);

			var font_size = element.attr("default");
			if (!font_size) font_size = jQuery(element.attr("selector")).css("font-size");
			
			element.val(parseInt(font_size));
				/*var element = $(this);
				jQuery(element.attr("selector")).css({fontFamily:this.value});*/
		});

		
		jQuery("#nico_theme_editor ._font_select").on("change", function() 
		{
				var element = $(this);
				if (jQuery("._font_" + this.value).length == 0)
				{
					var font = normalize_string(this.value);
					$('head').append('<link class="_font_' + this.value + '" rel="stylesheet" href="https://fonts.googleapis.com/css?family=' + this.value + '" type="text/css" />');
				}			

				jQuery(element.attr("selector")).css({fontFamily:this.value});
				
				if (!_nico_changes["fonts"]) _nico_changes["fonts"] = {};
				if (!_nico_changes["fonts"][element.attr("selector")]) _nico_changes["fonts"][element.attr("selector")] = {};				
				_nico_changes['fonts'][element.attr("selector")]['font-family'] = this.value;

/*				if (!_nico_changes["fonts"]) _nico_changes["fonts"] = {};
				_nico_changes['fonts'][element.attr("selector")] = this.value;*/
		});
		
		jQuery("#nico_theme_editor ._font_select_size").on("change", function() 
		{
				var element = $(this);
				jQuery(element.attr("selector")).css({fontSize:this.value + "px"});
				
				if (!_nico_changes["fonts"]) _nico_changes["fonts"] = {};
				if (!_nico_changes["fonts"][element.attr("selector")]) _nico_changes["fonts"][element.attr("selector")] = {};				
				_nico_changes['fonts'][element.attr("selector")]['size'] = this.value;
		});
}

var _backgrounds_first_load = true;
var _colors_first_load = true;
var _fonts_first_load = true;

function init_editor()
{
	$(".nico_tab").eq(0).show();
	
	jQuery("#nico_save_settings").on("click", function(e) 
		{
			if (_nico_changes)
			{
				_nico_changes["_nico_save_theme"] = true;
				nico_save_theme();
				
			} else
			{
				alert("Nothing to save, make some changes first");	
			}
			e.preventDefault();
			return false;
		});
		
		jQuery("#nico_reset").on("click", function(e) 
		{
			_nico_changes["_nico_reset_theme"] = true;
			nico_save_theme();
			e.preventDefault();
			return false;
		});
		
	
		$(".nico_tabs li").click(function(e) 
		{
			e.preventDefault();
			
			if (_backgrounds_first_load && this.innerHTML == "Background")
			{
				jQuery(".nico_status").text("Loading background patterns ...").show();
				_backgrounds_first_load = false;
				 $(".nico_tab > div").hide();
				 window.setTimeout(function() 
				 {
					init_backgrounds();
					$(".nico_tab > div").show();
					jQuery(".nico_status").text("").hide();
				}, 100);
			}
			if (_colors_first_load && this.innerHTML == "Colors")
			{
				jQuery(".nico_status").text("Loading colors ...").show();
				_colors_first_load = false;
				 window.setTimeout(function() 
				 {
					init_colors();
					jQuery(".nico_status").text("").hide();
				}, 100);
			}
			if (_fonts_first_load && this.innerHTML == "Fonts")
			{
				jQuery(".nico_status").text("Loading fonts ...").show();
				_fonts_first_load = false;
				 window.setTimeout(function() 
				 {
					init_fonts();
					jQuery(".nico_status").text("").hide();
				}, 100);
			}		  
			
		  var index = $(".nico_tabs li").removeClass("selected").index(this);
		  $(this).addClass("selected");
		  $(".nico_tab").hide().eq(index).show();
		});
		
		
		$(".nico_slide_text li").click(function(e) 
		{
		  var index = $(".nico_slide_text li").removeClass("selected").index(this);
		  $(this).addClass("selected");
		  $("div.nico_slide_text").hide().eq(index).show();
		});
		
		$("div.nico_slide_text").eq(0).show();
			
		jQuery("#nico_theme_editor .setting .value input[type=text]").on("keyup", function() 
		{
				var element = $(this);
				var attribute = element.attr("attribute");
				if (attribute == 'text')
				{
					jQuery(element.attr("selector")).text(this.value);
				} else
				{
					jQuery(element.attr("selector")).attr(attribute, this.value);
				}
				
				if (!_nico_changes["settings"]) _nico_changes["settings"] = {};
				_nico_changes['settings'][element.attr("name")] = this.value;
		});
		
		jQuery("#nico_theme_editor .setting .value input[type=checkbox]").on("change", function() 
		{
				var element = $(this);
				var attribute = element.attr("attribute");
				if (attribute == 'text')
				{
					jQuery(element.attr("selector")).text(this.value);
				} else
				{
					jQuery(element.attr("selector")).attr(attribute, this.value);
				}
				
				if (!_nico_changes["settings"]) _nico_changes["settings"] = {};
				_nico_changes['settings'][element.attr("name")] = this.checked;
		});
		
				
		jQuery("#nico_theme_editor .setting .value textarea, #nico_theme_editor .setting .value select").on("change", function() 
		{
				var element = $(this);
				var attribute = element.attr("attribute");
				if (attribute == 'text')
				{
					jQuery(element.attr("selector")).text(this.value);
				} else
				{
					jQuery(element.attr("selector")).attr(attribute, this.value);
				}
				
				if (!_nico_changes["settings"]) _nico_changes["settings"] = {};
				_nico_changes['settings'][element.attr("name")] = this.value;
		});
		
		/* ---- */
		jQuery("#nico_theme_editor .slider .value input[type=text]").on("keyup", function() 
		{
				var element = $(this);
				var attribute = element.attr("attribute");
				var page = element.attr("page");
				var slider = element.attr("slider");
				
				if (attribute == 'text')
				{
					jQuery(element.attr("selector")).text(this.value);
				} else
				{
					jQuery(element.attr("selector")).attr(attribute, this.value);
				}
				
				if (!_nico_changes["sliders"]) _nico_changes["sliders"] = {};
				if (!_nico_changes["sliders"][page]) _nico_changes["sliders"][page] = {};
				if (!_nico_changes["sliders"][page][slider]) _nico_changes["sliders"][page][slider] = {};
				
				_nico_changes['sliders'][page][slider][element.attr("_name")] = this.value;
		});
				
		jQuery("#nico_theme_editor .label_option input[type=radio], #nico_theme_editor .slider .value input[type=checkbox], #nico_theme_editor .slider .value input[type=radio]").on("change", function() 
		{
				var element = $(this);
				var attribute = element.attr("attribute");
				var page = element.attr("page");
				var slider = element.attr("slider");
				
				if (attribute == 'text')
				{
					jQuery(element.attr("selector")).text(this.value);
				} else
				{
					jQuery(element.attr("selector")).attr(attribute, this.value);
				}
				
				if (!_nico_changes["sliders"]) _nico_changes["sliders"] = {};
				if (!_nico_changes["sliders"][page]) _nico_changes["sliders"][page] = {};
				if (slider && !_nico_changes["sliders"][page][slider]) _nico_changes["sliders"][page][slider] = {};
				
				var value = '';
				if (this.type == "checkbox") value = this.checked; else value = this.value;
				if (!slider) _nico_changes['sliders'][page]['active'] = this.value;
				else _nico_changes['sliders'][page][slider][element.attr("_name")] = value;
		});
		
		jQuery("#nico_theme_editor .slider .value select").on("change", function() 
		{
			var element = jQuery(this);
			var page = element.attr("page");
			var slider = element.attr("slider");			
			
			if (!_nico_changes["sliders"]) _nico_changes["sliders"] = {};
			if (!_nico_changes["sliders"][page]) _nico_changes["sliders"][page] = {};
			if (!_nico_changes["sliders"][page][slider]) _nico_changes["sliders"][page][slider] = {};
				
			_nico_changes['sliders'][page][slider][element.attr("_name")] = element.val();
		});
		
				
		jQuery("#nico_theme_editor .slider .value textarea").on("change", function() 
		{
				var element = $(this);
				var attribute = element.attr("attribute");
				var page = element.attr("page");
				var slider = element.attr("slider");
				
				if (attribute == 'text')
				{
					jQuery(element.attr("selector")).text(this.value);
				} else
				{
					jQuery(element.attr("selector")).attr(attribute, this.value);
				}
				
				if (!_nico_changes["sliders"]) _nico_changes["sliders"] = {};
				if (!_nico_changes["sliders"][page]) _nico_changes["sliders"][page] = {};
				if (!_nico_changes["sliders"][page][slider]) _nico_changes["sliders"][page][slider] = {};
				
				_nico_changes['sliders'][page][slider][element.attr("_name")] = this.value;
		});
				
		
		/*jQuery("#nico_theme_editor .option select.value").each(function() 
		{
			var element = jQuery(this);
			element.val(jQuery(element.attr("selector")).css(element.attr("attribute")));
		});*/
					
		jQuery("#nico_theme_editor .option select.value").on("change", function() 
		{
			var element = jQuery(this);
			jQuery(element.attr("selector")).css(element.attr("attribute"), this.value);
			
			if (!_nico_changes["options"]) _nico_changes["options"] = {};
			if (!_nico_changes["options"][element.attr("selector")]) _nico_changes["options"][element.attr("selector")] = {};				
			_nico_changes['options'][element.attr("selector")][element.attr("attribute")] = this.value;
		});
		
		
		_nico_changes['styles']= {};
		var _css_backup = {};
		jQuery("#nico_theme_editor .style .value").hover(
		  function (e) 
		  {
			var $this = jQuery(this);  
			var group = $this.attr("group");
			var css = jQuery('#_style_css_' + group);
			var css_file =  $this.attr("css");
			
			if (css.length)
			{
				_css_backup[group] = css.attr("href");
				css.attr("href", css_file);
			} else
			{	
				_css_backup[group] = '';
				$('head').append('<link id="_style_css_' + group + '" rel="stylesheet" href="' + css_file + '" type="text/css" />');			  
			}
			  
		  }, 
		  function (e) 
		  {
			var $this = jQuery(this);  
			var group = $this.attr("group");
			var css = jQuery('#_style_css_' + group);

			css.attr("href", _css_backup[group]);
		  }
		).click(function (e)
		{
			var $this = jQuery(this);  
			var group = $this.attr("group");
			var css = jQuery('#_style_css_' + group);
			var css_file =  $this.attr("css");
			var file =  $this.attr("file");
			
			css.attr("href", css_file);
			_css_backup[group] = css_file;
			_nico_changes['styles'][group] = file;
			
			jQuery("#nico_theme_editor .style .value." + group).removeClass("selected");
			$this.addClass("selected")
		});
}

jQuery(document).ready(function()
{
		var _first_load = true;
		$("#show_hide_editor").on("click", function (e) 
		{
			var editor = jQuery("#nico_theme_editor");
			if (editor.css("height") == '0px')
			{
				jQuery(this).css({marginTop:"-20px", paddingBottom:"40px", opacity:"0.2",'z-index':'-2', 'margin-left':'0px',display:"none"}).text("Hide panel");
				jQuery("body").css("marginBottom", "300px");
				editor.animate({height:"300px"},500, function() { $("#show_hide_editor").fadeIn();});
				$.cookie('editor', 'true');
				if (_first_load)
				{
					_first_load = false;
					
					if (!is_writable) 
					{
								jQuery(".nico_status").html("<p>File <strong>/nico_theme_editor/settings.inc</strong> is not writable by php, <strong>saving will not work</strong>.<br>Set proper permission to make the file writable by php, 0766 if unsure.<br/>Check theme docs for more info.</p>").show();
								setTimeout('jQuery(".nico_status").text("").hide();', 20000);
					}
					
					init_editor();
				}
			} else
			{
				jQuery(this).css({marginTop:"-40px",paddingBottom:"40px", opacity:"1",'z-index':'-1', 'margin-left':'10px', display:"none"}).text("Customize theme");
				jQuery("body").css("marginBottom", "0px");
				editor.animate({height:"0px"},500, function() { $("#show_hide_editor").fadeIn();});
				$.cookie('editor', 'false');
			}
			
			e.preventDefault();
			return false;
		});
		if ($.cookie('editor') == "true") $("#show_hide_editor").click();
		
		
		//slider accordion
		$('.nico_tab.sliders div .label_option').click(function() {
			var $parent = this.parentNode;
			var $container = $(this).next();
			jQuery('> div.slider_container', $parent).not($container).slideUp('normal');
			$container.slideDown('normal');
		});
	 
	 
	 
		jQuery("#nico_zoom_bottomscreen").click(function(e) 
		{
			var editor = jQuery("#nico_theme_editor");
			var show_hide_editor = jQuery("#show_hide_editor");
			var prev_height = jQuery(".nico_tab").height();
			var height = 255;
			
			editor.animate({height:"300px"},500, function() 
			{ 
				if (prev_height > height)
				{
					jQuery(".nico_tab").css({height:height + "px"});					
				}
			});

			if (prev_height <= height)
			{
				jQuery(".nico_tab").css({height:height + "px"});					
			}
			
			//show_hide_editor.css({marginTop:"-40px",paddingBottom:"40px", opacity:"1", display:"none"}).text("Customize theme");
			editor.animate({height:"300px"},500);
			
			e.preventDefault();
			return false;
		});


		jQuery("#nico_zoom_halfscreen").click(function(e) 
		{
			var editor = jQuery("#nico_theme_editor");
			var prev_height = jQuery(".nico_tab").height();
			var height = ($(window).height() / 2) -45;
			
			editor.animate({height:"50%"},500, function() 
			{ 
				if (prev_height > height)
				{
					jQuery(".nico_tab").css({height:height + "px"});					
				}
			});

			if (prev_height <= height)
			{
				jQuery(".nico_tab").css({height:height + "px"});					
			}


			e.preventDefault();
			return false;
		});



		jQuery("#nico_zoom_fullscreen").click(function(e) 
		{
			var editor = jQuery("#nico_theme_editor");
			var prev_height = jQuery(".nico_tab").height();			
			var height = ($(window).height()) -45;
			
			editor.animate({height:"98%"},500, function() {
				if (prev_height > height)
				{
					jQuery(".nico_tab").css({height:height + "px"});					
				}
			});
			
			if (prev_height < height)
			{
				jQuery(".nico_tab").css({height:height + "px"});					
			}
			
			e.preventDefault();
			return false;
		});
		
		jQuery(".nico_add_slide").click(function (e)
		{
			e.preventDefault();
			var lang = this.getAttribute("lang");
			jQuery("div.nico_slide_text.lang_" + lang).append(_slide_text_template.replace("slider_text","slider_text lang_" + lang));
			return false;
		});
		
		jQuery(".nico_remove_slide").click(function (e)
		{
			e.preventDefault();
			var lang = this.getAttribute("lang");
			jQuery("div.nico_slide_text.lang_" + lang + " .slider_text:last-child").remove();
			return false;
		});
		
		var tree = $("#nico_menu");
		
	
		jQuery("#nico_menu").on("click", ".remove", function() {
			var node = this.parentNode.parentNode;
			if (confirm("Are you sure you want to remove this menu item and all it's submenus?") && tree.jstree("remove", node))
			{
			}
		});
		
		jQuery("#nico_menu").on("click", ".add_subcat", function() {
			jQuery("a", node).removeClass("jstree-clicked");

			var node = this.parentNode.parentNode;
			tree.jstree("create", node, "last","Menu item",  
				function(obj, name) {
					var clone = jQuery(".nico_new_menu_item_template").clone().attr("class","");
					jQuery("a",obj).addClass("jstree-clicked").after(clone);
					jQuery("input[name="+ current_lang + "]", obj).focus();
				}, true);
				
			return false;
		});
		
		jQuery(".nico_menu").on("click", "#nico_add_menu_item",function() 
		{
				jQuery(".jstree-clicked").removeClass("jstree-clicked");
				tree.jstree("create", -1, "last","Menu item",  
				function(obj, name) {
					var clone = jQuery(".nico_new_menu_item_template").clone().attr("class","");
					jQuery("a",obj).addClass("jstree-clicked").after(clone);
					jQuery("input[name="+ current_lang + "]", obj).focus();
				}, true);
				
				return false;
		});		
		
		jQuery(".nico_menu").on("click", "#nico_add_ocmenu_item",function() 
		{
				jQuery(".jstree-clicked").removeClass("jstree-clicked");
				tree.jstree("create", -1, "last","Opencart categories",  
				function(obj, name) {
					jQuery(obj).addClass("categories");;
					var clone = jQuery(".nico_new_menu_item_template").clone().attr("class","");
					jQuery("a",obj).addClass("jstree-clicked").after(clone);
					jQuery("input[name="+ current_lang + "]", obj).focus();
				}, true);
				
				return false;
		});			

		$("#nico_menu").jstree({"plugins" : [ "themes", "html_data", "cookie", "ui", "dnd", "crrm" ],
					"themes" : {
					"theme" : "classic",
					"dots" : false}});
		
		jQuery("#nico_menu").on("keyup", "input[name="+ current_lang + "]", function (e) {jQuery(".jstree-clicked ins").get(0).nextSibling.textContent = this.value});
});
